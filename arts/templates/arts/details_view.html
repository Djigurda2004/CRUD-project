{% extends 'main/more.html' %}
{% load mptt_tags %}
{% block content %}
<script src="https://unpkg.com/htmx.org@1.9.6"></script>
<script>
    function toggleElement(id, forceShow = false) {
        var x = document.getElementById(id);
        if (x) {
            if (forceShow) {
                x.style.display = "block";
            } else {
                x.style.display = (x.style.display === "none") ? "block" : "none";
            }
        }
    }
</script>
<div class="features">
    <h1>{{article.title}}</h1>
    <p>Date of publication: {{article.date}}</p>
    <p>Author: <a href="{%url 'users:profile' article.author.username %}">{{article.author.username}}</a></p>
    <p>{{article.full_text}}</p>
    <div class="mb-4">
        {% if article.author == request.user %}
            <a href="{%url 'arts:update' article.id%}" class="btn btn-info">Update article</a>
            <a href="{%url 'arts:delete' article.id%}" class="btn btn-danger">Delete article</a>
        {% endif %}
        {% if user.is_authenticated %}
            <form action="{% url 'arts:like' article.id %}" method="post" class="d-inline-block">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary">Like {{ article.total_likes }}</button>
            </form>
        {% endif %}
    </div>
    <div class="comments-section mt-5" style="max-width: 800px;">
        <h3>Comments</h3>
        {% if user.is_authenticated %}
            <div class="mb-4">
                <button class="btn btn-outline-dark mb-2" onclick="toggleElement('main-comment-form')">Add a comment</button>
                <div id="main-comment-form" style="display: none;">
                    <form hx-post="{% url 'comments:add' article.id %}" 
                          hx-target="#root-comments-container" 
                          hx-swap="afterbegin"
                          onsubmit="setTimeout(() => { this.reset(); toggleElement('main-comment-form'); }, 100);">
                        {% csrf_token %}
                        <textarea name="text" class="form-control mb-2" rows="3" placeholder="Share your thoughts..." required></textarea>
                        <button type="submit" class="btn btn-success">Post Comment</button>
                    </form>
                </div>
            </div>
        {% else %}
            <p><a href="{% url 'users:login' %}">Log in</a> to leave a comment.</p>
        {% endif %}
        <div id="root-comments-container">
            {% for comment in article.comments.all %}
                {% if comment.is_root_node %}
                    {% include "comments/comments.html" with node=comment %}
                {% endif %}
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
{% block title %}{{article.title}}{% endblock %}